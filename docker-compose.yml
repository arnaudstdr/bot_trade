# UTILISATION:
#
# Mode interface web (par défaut) - l'interface contrôle le bot:
#   docker compose up -d
#   Accès: http://localhost:5005
#
# Mode standalone - bot qui tourne seul sans interface:
#   docker compose --profile standalone up -d
#
# Arrêter:
#   docker compose down

services:
  # Mode standalone : bot qui tourne seul sans interface
  trading-agent:
    profiles: ["standalone"]
    build: .
    container_name: trading-agent
    restart: unless-stopped

    volumes:
      # Monter le fichier de configuration
      - ./config.py:/app/config.py:ro

      # Monter le répertoire data local (pour accès direct aux fichiers)
      - ./data:/app/data

      # Optionnel: monter les logs
      - ./logs:/app/logs

    # Politique de redémarrage
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

    # Limites de ressources (adapté pour Raspberry Pi)
    mem_limit: 512m
    cpus: 1.0

    # Logs
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Labels pour l'organisation
    labels:
      - "com.trading-agent.description=Agent de trading autonome (mode standalone)"
      - "com.trading-agent.version=1.0"

  # Interface web avec contrôle du bot (mode par défaut)
  web-interface:
    build: .
    container_name: trading-web
    restart: unless-stopped
    command: python3 web_interface.py

    # Exposer le port de l'interface web
    ports:
      - "5005:5005"

    volumes:
      # Monter le fichier de configuration
      - ./config.py:/app/config.py:ro

      # Monter le répertoire data (partagé avec l'agent)
      - ./data:/app/data

      # Monter les templates et static
      - ./templates:/app/templates:ro
      - ./static:/app/static:ro

    # Limites de ressources (augmentées pour héberger bot + interface)
    mem_limit: 768m
    cpus: 1.5

    # Logs
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Labels
    labels:
      - "com.trading-agent.description=Interface web avec contrôle du bot de trading"
      - "com.trading-agent.version=1.0"
