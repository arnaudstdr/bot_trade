services:
  trading-agent:
    build: .
    container_name: trading-agent
    restart: unless-stopped

    # Variables d'environnement depuis config.py
    # Le conteneur utilise directement le fichier config.py monté

    volumes:
      # Monter le fichier de configuration
      - ./config.py:/app/config.py:ro

      # Monter le répertoire data local (pour accès direct aux fichiers)
      - ./data:/app/data

      # Optionnel: monter les logs
      - ./logs:/app/logs

    # Politique de redémarrage
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

    # Limites de ressources (adapté pour Raspberry Pi)
    mem_limit: 512m
    cpus: 1.0

    # Logs
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Labels pour l'organisation
    labels:
      - "com.trading-agent.description=Agent de trading autonome"
      - "com.trading-agent.version=1.0"

  web-interface:
    build: .
    container_name: trading-web
    restart: unless-stopped
    command: python3 web_interface.py

    # Exposer le port de l'interface web
    ports:
      - "5005:5005"

    volumes:
      # Monter le fichier de configuration
      - ./config.py:/app/config.py:ro

      # Monter le répertoire data (partagé avec l'agent)
      - ./data:/app/data

      # Monter les templates et static
      - ./templates:/app/templates:ro
      - ./static:/app/static:ro

    # Limites de ressources
    mem_limit: 256m
    cpus: 0.5

    # Logs
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # L'interface web dépend de l'agent (pour les données)
    depends_on:
      - trading-agent

    # Labels
    labels:
      - "com.trading-agent.description=Interface web du bot de trading"
      - "com.trading-agent.version=1.0"
